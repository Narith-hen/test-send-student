<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students - Student Result System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <span class="text-xl font-bold">Student Result System</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm">Welcome, <span id="userName" class="font-semibold"></span></span>
                    <a href="/logout" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar & Content -->
    <div class="flex">
        <!-- Sidebar -->
        <aside class="bg-white w-64 min-h-screen shadow-lg">
            <nav class="p-4">
                <a href="/dashboard" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700 mb-2 transition-all">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/upload" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700 mb-2 transition-all">
                    <i class="fas fa-upload"></i>
                    <span>Upload Results</span>
                </a>
                <a href="/students" class="flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white mb-2">
                    <i class="fas fa-users"></i>
                    <span>Students</span>
                </a>
                <a href="/logs" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700 mb-2 transition-all">
                    <i class="fas fa-history"></i>
                    <span>Email Logs</span>
                </a>
                <a href="/settings" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700 mb-2 transition-all">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-users mr-3"></i>Student Management
                </h1>
                <div class="flex items-center space-x-4">
                    <div class="bg-white px-4 py-2 rounded-lg shadow">
                        <span class="text-gray-600">Total Students: </span>
                        <span class="font-bold text-purple-600" id="totalCount">0</span>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-lg shadow">
                        <span class="text-gray-600">Selected: </span>
                        <span class="font-bold text-blue-600" id="selectedCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" id="selectAll" class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                        <label for="selectAll" class="font-semibold text-gray-700">Select All</label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="searchInput" placeholder="Search students..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <button onclick="sendEmails()" id="sendBtn" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-2 rounded-lg hover:from-green-600 hover:to-teal-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-paper-plane mr-2"></i>Send Results
                        </button>
                    </div>
                </div>
            </div>

            <div id="message" class="mb-4 hidden"></div>

            <!-- Students Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                            <tr>
                                <th class="px-6 py-4 text-left">
                                    <input type="checkbox" class="w-5 h-5 rounded">
                                </th>
                                <th class="px-6 py-4 text-left">Name</th>
                                <th class="px-6 py-4 text-left">Email</th>
                                <th class="px-6 py-4 text-center">English</th>
                                <th class="px-6 py-4 text-center">Prof. Life</th>
                                <th class="px-6 py-4 text-center">Algorithm</th>
                                <th class="px-6 py-4 text-center">Web Design</th>
                                <th class="px-6 py-4 text-center">Total</th>
                                <th class="px-6 py-4 text-center">Average</th>
                                <th class="px-6 py-4 text-center">Grade</th>
                                <th class="px-6 py-4 text-center">Year</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable" class="divide-y divide-gray-200">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden bg-white rounded-xl shadow-lg p-12 text-center">
                <i class="fas fa-users-slash text-6xl text-gray-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">No Students Found</h3>
                <p class="text-gray-500 mb-6">Upload a student results file to get started</p>
                <a href="/upload" class="inline-block bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all">
                    <i class="fas fa-upload mr-2"></i>Upload Results
                </a>
            </div>
        </main>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                <i class="fas fa-paper-plane mr-2 text-purple-600"></i>Sending Emails
            </h3>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Progress</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-green-500 to-teal-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <p class="text-center text-gray-600" id="progressMessage">Preparing to send emails...</p>
        </div>
    </div>

    <script>
        let students = [];
        let selectedStudents = new Set();

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const data = await response.json();

                if (data.success) {
                    students = data.students;
                    displayStudents(students);
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function displayStudents(studentsToDisplay) {
            const tbody = document.getElementById('studentsTable');
            const emptyState = document.getElementById('emptyState');
            const table = tbody.closest('.bg-white');

            if (studentsToDisplay.length === 0) {
                table.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            table.classList.remove('hidden');
            emptyState.classList.add('hidden');

            tbody.innerHTML = studentsToDisplay.map(student => {
                const average = (student.term1_total / 4).toFixed(2);
                const grade = getGrade(average);
                const gradeColor = getGradeColor(grade);

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="student-checkbox w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500" data-id="${student.id}">
                        </td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${student.name}</td>
                        <td class="px-6 py-4 text-gray-600">${student.email}</td>
                        <td class="px-6 py-4 text-center"><span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full">${student.english}</span></td>
                        <td class="px-6 py-4 text-center"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">${student.professional_life}</span></td>
                        <td class="px-6 py-4 text-center"><span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">${student.algorithm}</span></td>
                        <td class="px-6 py-4 text-center"><span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full">${student.web_design}</span></td>
                        <td class="px-6 py-4 text-center font-bold text-gray-800">${student.term1_total}</td>
                        <td class="px-6 py-4 text-center font-semibold">${average}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full font-bold ${gradeColor}">${grade}</span>
                        </td>
                        <td class="px-6 py-4 text-center text-gray-600">${student.year}</td>
                    </tr>
                `;
            }).join('');

            // Add event listeners to checkboxes
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelection);
            });

            document.getElementById('totalCount').textContent = studentsToDisplay.length;
        }

        function getGrade(average) {
            if (average >= 90) return 'A';
            if (average >= 80) return 'B';
            if (average >= 70) return 'C';
            if (average >= 60) return 'D';
            return 'F';
        }

        function getGradeColor(grade) {
            const colors = {
                'A': 'bg-green-100 text-green-800',
                'B': 'bg-blue-100 text-blue-800',
                'C': 'bg-yellow-100 text-yellow-800',
                'D': 'bg-orange-100 text-orange-800',
                'F': 'bg-red-100 text-red-800'
            };
            return colors[grade] || 'bg-gray-100 text-gray-800';
        }

        // Select all functionality
        document.getElementById('selectAll').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateSelection();
        });

        function updateSelection() {
            selectedStudents.clear();
            document.querySelectorAll('.student-checkbox:checked').forEach(checkbox => {
                selectedStudents.add(parseInt(checkbox.dataset.id));
            });

            document.getElementById('selectedCount').textContent = selectedStudents.size;
            document.getElementById('sendBtn').disabled = selectedStudents.size === 0;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = students.filter(student => 
                student.name.toLowerCase().includes(searchTerm) ||
                student.email.toLowerCase().includes(searchTerm)
            );
            displayStudents(filtered);
        });

        // Send emails
        async function sendEmails() {
            if (selectedStudents.size === 0) return;

            const modal = document.getElementById('progressModal');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressMessage = document.getElementById('progressMessage');

            modal.classList.remove('hidden');

            try {
                const response = await fetch('/api/send-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_ids: Array.from(selectedStudents)
                    })
                });

                const data = await response.json();

                // Simulate progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';

                    if (progress >= 100) {
                        clearInterval(interval);
                        progressMessage.textContent = 'Emails sent successfully!';
                        
                        setTimeout(() => {
                            modal.classList.add('hidden');
                            showMessage(`✅ ${data.message}`, 'success');
                            selectedStudents.clear();
                            document.getElementById('selectAll').checked = false;
                            updateSelection();
                        }, 1500);
                    }
                }, 200);

            } catch (error) {
                modal.classList.add('hidden');
                showMessage('❌ An error occurred while sending emails.', 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `p-4 rounded-lg border ${type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'}`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');

            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        // Load students on page load
        loadStudents();
    </script>
</body>
</html>
